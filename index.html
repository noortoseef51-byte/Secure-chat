<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HQ CYBER PRO </title>
  
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <style>
    :root { --glow: #00f2ff; --bg: #050508; --gold: #ffd700; --red: #ff0000; --green: #00ff88; }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    
    html, body { height: 100%; width: 100%; overflow: hidden; background: var(--bg); color: white; font-family: 'Rajdhani', sans-serif; }
    body { display: flex; flex-direction: column; }

    /* Super Entry Overlay */
    #superEntry { position: fixed; inset: 0; background: #000; z-index: 50000; display: none; align-items: center; justify-content: center; border: 15px solid var(--red); }
    .entry-text { color: var(--red); font-family: 'Orbitron'; font-size: 30px; text-align: center; animation: shake 0.1s infinite; text-shadow: 0 0 20px var(--red); }
    @keyframes shake { 0% { transform: translate(3px, 3px); } 50% { transform: translate(-3px, -3px); } 100% { transform: translate(0); } }

    header { background: #000; padding: 12px; border-bottom: 2px solid var(--glow); flex-shrink: 0; z-index: 1000; }
    .nav-container { display: flex; justify-content: space-around; }
    .master-icon { font-size: 26px; cursor: pointer; background: none; border: none; filter: drop-shadow(0 0 5px var(--glow)); }

    #main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* Camera Section */
    #left-side { display: flex; gap: 10px; padding: 10px; overflow-x: auto; background: #000; border-bottom: 1px solid #222; min-height: 125px; flex-shrink: 0; scrollbar-width: none; }
    .vid-box { width: 140px; height: 105px; border: 2px solid var(--glow); border-radius: 8px; position: relative; flex-shrink: 0; overflow: hidden; background: #111; }
    video { width: 100%; height: 100%; object-fit: cover; }
    .vid-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); font-size: 10px; text-align: center; color: var(--glow); padding: 2px 0; }

    /* Input Section */
    #input-section { background: #0a0a0a; padding: 10px; display: flex; gap: 8px; flex-shrink: 0; border-bottom: 1px solid #333; }
    #mInp { flex: 1; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-size: 14px; }
    .send-btn { background: var(--glow); border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; color: #000; cursor: pointer; }

    /* Chat Messages */
    #msgs { flex: 1; overflow-y: auto !important; -webkit-overflow-scrolling: touch; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .msg-box { padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); border-left: 4px solid var(--glow); flex-shrink: 0; word-break: break-all; animation: slideIn 0.2s ease-out; }
    @keyframes slideIn { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    #yt-container { display:none; width:100%; aspect-ratio:16/9; background:#000; flex-shrink: 0; border-bottom: 2px solid var(--red); }

    /* Floating Menus */
    .mgmt-box { display: none; position: fixed; background: #0d0d0d; border: 2px solid var(--gold); padding: 12px; border-radius: 12px; z-index: 10000; width: 220px; box-shadow: 0 0 30px rgba(0,0,0,1); }
    .mgmt-box button { width: 100%; padding: 12px; margin-bottom: 8px; background: #1a1a1a; border: 1px solid #333; color: white; cursor: pointer; text-align: left; font-size: 12px; font-family: 'Orbitron'; border-radius: 6px; }

    /* Login Screen */
    #login { position: fixed; inset: 0; background: #000; z-index: 30000; display: flex; align-items: center; justify-content: center; }
    .hidden { display: none !important; }
    .selector-item { padding: 14px; border-bottom: 1px solid #222; cursor: pointer; color: var(--glow); font-weight: bold; }
  </style>
</head>
<body onclick="closeAllMenus()">

  <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

  <div id="superEntry">
    <div class="entry-text">SYSTEM OVERRIDE<br>BOSS DETECTED!</div>
  </div>

  <div id="login">
    <div style="width: 85%; max-width: 320px; text-align: center;">
      <h1 style="font-family:Orbitron; color:var(--glow); margin-bottom:25px; letter-spacing: 2px;">CYBER PRO V12.8</h1>
      <input type="text" id="u" placeholder="NICKNAME" style="width:100%; padding:15px; margin-bottom:15px; background:#111; color:white; border:1px solid #333; border-radius:10px;">
      <input type="password" id="p" placeholder="ACCESS CODE" style="width:100%; padding:15px; margin-bottom:25px; background:#111; color:white; border:1px solid #333; border-radius:10px;">
      <button onclick="connect()" style="width:100%; padding:16px; background:var(--glow); border:none; border-radius:10px; font-family:Orbitron; font-weight:bold; cursor:pointer;">INITIALIZE</button>
    </div>
  </div>

  <header id="h" class="hidden">
    <div class="nav-container">
      <button class="master-icon" onclick="openMenu(event, 'shieldMenu')">üõ°Ô∏è</button>
      <button class="master-icon" onclick="openMenu(event, 'mediaMenu')">üé•</button>
      <button class="master-icon" onclick="openMenu(event, 'visionMenu')">üëÅÔ∏è</button>
      <button class="master-icon" onclick="openMenu(event, 'chaosMenu')">‚ö°</button>
      <button class="master-icon" style="color:var(--green);" onclick="openMenu(event, 'userToolMenu')">‚öôÔ∏è</button>
    </div>
  </header>

  <div id="main-container" class="hidden">
    <div id="left-side"></div>
    <div id="yt-container"></div>
    <div id="input-section">
      <input type="text" id="mInp" placeholder="Execute command..." onkeypress="if(event.key==='Enter') sendMsg()">
      <button onclick="sendMsg()" class="send-btn">SEND</button>
    </div>
    <div id="msgs"></div>
  </div>

  <div id="shieldMenu" class="mgmt-box">
    <button onclick="openSelector('KICK')" style="color:var(--red);">üö´ KICK USER</button>
    <button onclick="openSelector('UNKICK')" style="color:var(--green);">üîì UNKICK USER</button>
    <button onclick="openSelector('VIP')" style="color:var(--gold);">üíé GIVE VIP</button>
    <button onclick="delAllChat()" style="color:var(--red); border-top:1px solid #444;">üî• WIPE ALL DATA</button>
  </div>

  <div id="mediaMenu" class="mgmt-box">
    <button onclick="startCam()">üìπ START LIVE CAM</button>
    <button onclick="stopCam()">üö´ STOP STREAM</button>
    <button onclick="toggleMic()" style="color:var(--green);">üéôÔ∏è MIC TOGGLE</button>
    <button onclick="startYt()">üì∫ START YOUTUBE</button>
    <button onclick="stopYt()">‚èπÔ∏è STOP YOUTUBE</button>
  </div>

  <div id="visionMenu" class="mgmt-box">
    <button onclick="ghostMode()">üëª GHOST MODE</button>
    <button onclick="toggleVisibility('hidden')">üåë GO INVISIBLE</button>
    <button onclick="toggleVisibility('visible')">üü¢ GO VISIBLE</button>
  </div>

  <div id="chaosMenu" class="mgmt-box">
    <button onclick="sendAnnouncement()" style="color:var(--green);">üì¢ ANNOUNCEMENT</button>
    <button onclick="triggerChaos('RELOAD')" style="color:var(--red);">‚ò£Ô∏è REBOOT SYSTEM</button>
    <button onclick="triggerChaos('FLASH')">‚ö° FLASH SCREEN</button>
  </div>

  <div id="userToolMenu" class="mgmt-box">
    <button onclick="location.reload()">üîÑ REFRESH APP</button>
    <button onclick="toggleInvert()">üåì TOGGLE THEME</button>
  </div>

  <div id="userSelector" class="mgmt-box" style="width:260px; left:50%; top:50%; transform:translate(-50%,-50%); border-color:var(--glow);">
    <h3 id="selectorTitle" style="font-size:14px; text-align:center; color:var(--glow); margin-bottom:10px;">TARGET SELECTOR</h3>
    <div id="listBody" style="max-height:250px; overflow-y:auto;"></div>
    <button onclick="closeAllMenus()" style="margin-top:10px; background:#333; text-align:center;">CANCEL</button>
  </div>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyA806HxxZejS_l5_pWAb9cJ0pbbhNhgR8A", authDomain: "call-2b58d.firebaseapp.com", projectId: "call-2b58d", appId: "1:693359105489:web:6802540c272a565d27bcf0" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let myName = "", isSuper = false, localStream = null, peer = null;
    let activeCalls = {};

    async function connect() {
      const u = document.getElementById("u").value.trim().toUpperCase();
      const p = document.getElementById("p").value;
      if(!u) return;
      isSuper = (p === "1661@786");
      if(!isSuper && p !== "1234") return alert("INVALID ACCESS CODE");
      
      myName = u;
      if(isSuper) {
        document.getElementById("superEntry").style.display = "flex";
        try { document.getElementById("alertSound").play(); } catch(e){}
        setTimeout(() => document.getElementById("superEntry").style.display = "none", 3000);
      }
      document.getElementById("login").classList.add("hidden");
      document.getElementById("h").classList.remove("hidden");
      document.getElementById("main-container").classList.remove("hidden");
      initApp();
    }

    function initApp() {
      // Create Peer with consistent ID
      const myPeerId = myName + "_" + Math.floor(Math.random()*1000);
      peer = new Peer(myPeerId);

      peer.on('open', (id) => {
        db.collection('status').doc(myName).set({online:true, peerId: id, lastSeen: Date.now()});
      });

      // Listen for Incoming Stream
      peer.on('call', call => {
        call.answer(localStream); // Answer with stream if active
        call.on('stream', s => addVideo(call.peer.split('_')[0], s));
      });
      
      // Sync Online Users & Auto-Call
      db.collection('status').onSnapshot(snap => {
        snap.forEach(doc => {
          const data = doc.data();
          if(doc.id !== myName && data.online && localStream && !activeCalls[doc.id]) {
            makeCall(data.peerId, doc.id);
          }
        });
      });

      // Chat Sync with Auto Scroll
      db.collection('rooms').doc('hq').collection('chat').orderBy('time','asc').limitToLast(40).onSnapshot(snap => {
        const box = document.getElementById("msgs");
        box.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          box.innerHTML += `<div class="msg-box"><b>${d.name}:</b> ${d.msg}</div>`;
        });
        box.scrollTop = box.scrollHeight;
      });

      // System Commands Sync
      db.collection('rooms').doc('hq').onSnapshot(doc => {
        const d = doc.data();
        if(d?.ytId) {
          document.getElementById("yt-container").style.display = "block";
          document.getElementById("yt-container").innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${d.ytId}?autoplay=1" frameborder="0"></iframe>`;
        } else { document.getElementById("yt-container").style.display = "none"; }
        if(d?.chaos === 'RELOAD' && !isSuper) location.reload();
        if(d?.flash) { document.body.style.background="white"; setTimeout(()=>document.body.style.background="var(--bg)",150); }
      });
    }

    async function startCam() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        addVideo('ME', localStream);
        // Call everyone online
        const snap = await db.collection('status').get();
        snap.forEach(doc => {
          const data = doc.data();
          if(doc.id !== myName && data.online) makeCall(data.peerId, doc.id);
        });
      } catch(e) { alert("Camera Access Denied"); }
    }

    function makeCall(targetPeerId, targetName) {
      if(!localStream || activeCalls[targetName]) return;
      const call = peer.call(targetPeerId, localStream);
      activeCalls[targetName] = call;
      call.on('stream', s => addVideo(targetName, s));
    }

    function addVideo(id, stream) {
      if(document.getElementById("vid_"+id)) return;
      const div = document.createElement("div"); div.className="vid-box"; div.id="vid_"+id;
      const v = document.createElement("video"); v.srcObject = stream; v.autoplay = true; v.playsinline = true;
      if(id === 'ME') v.muted = true;
      const l = document.createElement("div"); l.className="vid-label"; l.innerText=id;
      div.append(v, l); document.getElementById("left-side").appendChild(div);
    }

    function stopCam() {
      if(localStream){ localStream.getTracks().forEach(t=>t.stop()); location.reload(); }
    }

    function sendMsg() { 
      const i=document.getElementById("mInp"); 
      if(i.value.trim()){ 
        db.collection('rooms').doc('hq').collection('chat').add({name:myName, msg:i.value, time:Date.now()}); 
        i.value=""; 
      } 
    }

    // Controls
    function openMenu(e, id) { e.stopPropagation(); closeAllMenus(); if((id==='shieldMenu'||id==='chaosMenu') && !isSuper) return; document.getElementById(id).style.display="block"; }
    function closeAllMenus() { document.querySelectorAll('.mgmt-box').forEach(m => m.style.display="none"); }
    function startYt() { const id = prompt("YouTube ID:"); if(id) db.collection('rooms').doc('hq').update({ytId: id}); }
    function stopYt() { db.collection('rooms').doc('hq').update({ytId: null}); }
    function triggerChaos(t) { db.collection('rooms').doc('hq').update({chaos:t}); setTimeout(()=>db.collection('rooms').doc('hq').update({chaos:null}), 1000); }
    function toggleInvert() { document.body.style.filter = (document.body.style.filter === 'invert(1)') ? 'invert(0)' : 'invert(1)'; }
    function delAllChat() { if(confirm("WIPE EVERYTHING?")) db.collection('rooms').doc('hq').collection('chat').get().then(s=>s.forEach(d=>d.ref.delete())); }
    
    // User Selector for Admin
    async function openSelector(act) {
      closeAllMenus();
      const b = document.getElementById("listBody");
      b.innerHTML = "Loading...";
      const snap = await db.collection('status').get();
      b.innerHTML = "";
      snap.forEach(doc => {
        if(doc.id === myName) return;
        const d = document.createElement("div"); d.className = "selector-item"; d.innerText = doc.id;
        d.onclick = () => { 
            if(confirm(act + " " + doc.id + "?")) {
                db.collection('rooms').doc('hq').collection('chat').add({name:'üõ°Ô∏è SYSTEM', msg: doc.id + " " + act + "ED", time:Date.now()});
            }
            closeAllMenus();
        };
        b.append(d);
      });
      document.getElementById("userSelector").style.display = "block";
    }
  </script>
</body>
</html>
